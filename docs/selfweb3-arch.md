# SelfWeb3

[简体中文][1]

### An on-chain privatization solution that binds Web3 to the user one-to-one, off-chain dynamic authorization (Email + TOTP + WebAuthn) + multi-party signature guarantee + on-chain mandatory verification

![/docs/selfweb3.png](/docs/selfweb3.png)

## Contract

1. **Arbitrum Goerli, 421613: 0xec04F8Ee0493f3d763AB1624BB6aAcaCD94Ac4C1**

## Security model: [https://refitself.medium.com/a-privatized-web3-security-model-selfweb3-209439c5d8e2][2]

## Architecture

### Principle: After dynamic authorization is completed off-chain, it is guaranteed by multi-party signatures invisible to each other to prove the legitimacy of the user's identity on the chain. All parties restrict each other to ensure decentralized operation while providing highly secure privacy protection.

![/docs/selfweb3-arch.png](/docs/selfweb3-arch.png)

#### Description: The public and private key refers to the public and private key pair generated by the elliptic curve secp256k1 algorithm. The key refers to the 32-bit plaintext string. dhKey refers to the shared key dynamically calculated through the private key and public key.

> - web3 contract: The private key is protected against tampering. On-chain data acquisition and update rely on user private dynamic authorization and mandatory association verification on the chain.

> - wasm computing: As a privacy computing node, it handles all plaintext computing tasks related to private keys and private data, as well as off-chain verification of private dynamic authorization.

> - web2 service: As a guarantor, it provides endorsement for association verification, supports request forwarding, ciphertext data storage and other services, no session, no state, only processes ciphertext data

> - web3 storage: As a storage node, it provides support for users’ private signatures. On-chain verification relies on data provided by multi-party storage to generate signatures. Each is invisible and restricts each other.

> - Dynamic authorization: As an off-chain implementation to prove user identity, including Email, TOTP, WebAuthn, etc., the authority is verified through the on-chain contract through associated verification.

> - Association verification: used as a proof mechanism to ensure the validity of private dynamic authorization, including off-chain association verification, dynamic generation of multi-party signatures, and generation of Merkle tree certificates

> - On-chain verification: As a proof mechanism to ensure the legality of on-chain operations, including on-chain multi-party signature verification and Merkel tree replay attack verification

> - web front end: web2, web3 interactive gateway, all web2 services and web3 dapp entrance

## Hybrid storage architecture

### web2 centralized service: private key is encrypted and stored
> - web2Key: Unified key used for encrypted storage of web2 service data, not available to the public
> - web2Nonce: the random number of the web2 service itself, cooperates with the private random number, and is not available to the outside world
> - web2Data: Provide users with private data ciphertext backup storage service to improve user experience, processed by wasm
> - web2Private: The private key of the web2 service itself, used to generate web2 signatures and dynamically synthesize web2DHKey, not available to the public

### web3 contract storage: private key + wallet encrypted storage
> - web2 address: used to verify web2 service signature
> - recoverID: web3 private key signature + wallet signature verification
> - selfKey: web2DHKey encryption + wallet encryption + wallet signature verification
> - selfPrivate: selfKey encryption + selfPass encryption + wallet signature verification
   
### Private data storage: selfKey encrypted storage => web2 + web3
> - TOTPKey: used for TOTP authentication, selfDHKey encryption
> - selfNonce: private random number, collaborates with web2 random number
> - web3Public: used to generate private addresses and dynamically synthesize web2DHKey and selfDHKey, web3 private key is discarded
> - web2DHKey: A shared key generated by dynamic calculation of web2 private key and web3 public key. It is used as the user's key in web2 service and is also used to encrypt selfKey.

## Security model: hybrid encryption + private dynamic authorization + associated authentication

### Hybrid encryption

> - Purpose: Ensure that private keys are highly secure under the protection of multi-party encryption, and are used to securely store private data in a web2 centralized or web3 decentralized environment.
> - Implementation principle: The web2 shared key web2DHKey is first encrypted and then the user wallet is encrypted. The web2DHKey encryption is to prevent the user's wallet from being stolen, so that the private key remains safe. The wallet is encrypted again to prevent tampering with the zero-trust web2 service. private key

## Private dynamic authorization

> - Wallet: Signed by the wallet private key and verified within the web3 contract

> - TOTP: The wasm part is responsible for dynamically calculating selfDHKey and then performing dynamic verification, participating in association verification, and verifying the validity of dynamic authorization on the chain.

> - Email: wasm is responsible for caching the dynamic verification code and completing the verification, the web2 service is responsible for sending it, participating in the association verification, and the dynamic authorization validity is verified on the chain

> - WebAuthn: The wasm part is responsible for dynamically calculating selfDHKey and decrypting the WehAuthn credential ciphertext, participating in association verification, and verifying the validity of dynamic authorization on the chain.

### Association verification (off-chain signature generation + off-chain Merkle tree proof generation + on-chain dynamic verification):

> - Implementation purpose: Mandatory verification of the validity of associated dynamic authorization on the chain. Sensitive operations can be completed on the chain only if all signatures are verified. At the same time, the validity of leaf nodes is verified through the Merkel tree to prevent replay attacks.
> - Implementation principle: The web2 service and the wasm part generate dynamic random numbers respectively, add the existing Merkle tree and generate the corresponding proof. At the same time, the two parts use their respective private keys to sign the random numbers, and all parameters are packaged and sent. The contract performs signature verification and random number validity verification
> - Implementation method: The web2 service manages the Merkle tree for dynamic verification on the chain and dynamically generates signatures for guarantee. The wasm part generates signatures and random numbers through the self private key to ensure private operations. The web3 contract is responsible for verifying all signatures and Merkle Validity of Ershu Proof
> - Replay attack: In order to prevent signature leakage leading to replay attacks, only verify signatures and Merkel tree certificates for on-chain update operations, verify whether leaf nodes are valid in the web3 contract to prove whether to repeat verification, and re-verify after passing the verification. Construct the hash value of the root node of the Merkel tree

## Features

### web3 privatization (selfWeb3)

1. Forcibly bind the operation rights on the web3 chain to the users themselves, and the ownership of web3 data truly belongs to the users themselves.

2. Improve mandatory protection through methods such as webAuthn, TOTP and email verification, as well as the associated verification mechanism generated by off-chain to prove on-chain verification.

3. Due to the mandatory binding of private dynamic authorization, the wallet only serves as a tool to interact with the web3 contract and supports rebinding the wallet after private dynamic authorization.

### Privatization of user data ownership (web3 contract)

1. The contract is responsible for storing the key ciphertext used for dynamic authorization verification. The blockchain provides anti-tampering security guarantee and will support multiple chains in the future.

2. Responsible for dynamic verification of user identity and operation legitimacy, including wallet signature verification, private signature verification, web2 service signature verification, etc.

3. Responsible for providing specific web3 services, including private vaults, private NFT sets and other user web3 data, etc.

### Privacy and Security Computing (WebAssembly)

1. As a privacy computing node, it handles all plaintext computing tasks related to private keys and private data, as well as off-chain verification of private dynamic authorization. At the same time, all operations rely on the successful decryption of private data to support user data privacy and security.

2. The legality of wasm files is guaranteed by dynamically calculated file hash values and dynamic verification of legality by on-chain contracts. At the same time, only ciphertext data is cached to support runtime calculations and authorization verification tasks.

3. WebAuthn authorization is temporarily supported by the web2 service, but the web2 service can be compiled and deployed by itself through the source code, and will be optimized and upgraded for the decentralized operation of web3 in the future.

4. The web2 service and the wasm part use a temporary asymmetric ecdsa key pair to calculate the shared key for point-to-point encrypted communication.

### web2service

1. In order to ensure the privacy of the guarantor, only part of the code is open source and supports private deployment of services.

2. In order to ensure high-strength security, only stateless services related to ciphertext are provided, without sessions.

3. Only acts as a centralized node to improve user experience. After the user ciphertext data is stored in the web3 decentralized platform, it is also stored in the web2 service for quick retrieval.

4. As a zero-trust centralized service, it provides directed value-added services such as web2 request forwarding (such as email sending), authorization correlation verification and management, and encrypted data storage and retrieval.

## Association verification process

> - Deployment process: web2 service generates public and private keys, deploys web3 contract and provides web2 service address

> - Dynamic authorization (off-chain verification): web starts the dynamic authorization process -> the wasm part completes the dynamic verification -> the wasm part generates random numbers and signs them

> - Association verification (web2 verification): web requests the web2 service to obtain the signature and Merkle tree certificate -> the web2 service completes the correlation verification of dynamic authorization -> the web2 service signs and generates the Merkle tree certificate

> - Association verification (on-chain verification): The web requests the contract on the chain to verify signatures and certificates -> the contract verifies whether all signatures are legal, and then verifies whether the random numbers are legal through the Merkle tree -> if the verification is successful, the Merkle tree is updated Root hash -> update contract status

> - Process description: If the web3 mode is enabled, dynamic signatures cannot be obtained due to the lack of web2 service support. In order to ensure non-essential web2 service dependencies, the web3 contract will forcefully verify multi-party signatures and Merkle trees for on-chain update operations. The validity of leaf nodes, but priority is given to wallet signature verification and single private signature verification. The signature guarantee of the web2 service is introduced to enhance the security of association verification through the web2 service and the user's own private signature. At the same time, only the wasm part Only then can the user's private key and data be obtained, and the association verification can be prevented from illegally passing by generating a dynamic random number and signing it.

## Core business process

> - Supports privatized web3 business process operations after all dynamic verifications such as wallet signature, private dynamic authorization, association verification, etc.

### web2 mode

1. The initialization process needs to first complete the signature verification of the web2 service on the chain contract and the legality verification of the wasm file, otherwise no data in the contract can be queried and updated.

2. Supports data reading and writing to web3 contracts and web2 services. The private dynamic authorization process requires associated verification, that is, wallet -> email -> TOTP -> webAuthn

4. The web3 public key is randomly generated and the private key is discarded after signing the recovery ID. It is used to generate private addresses and participate in the calculation of the shared key. It is encrypted and stored in the web2 service and web3 decentralized storage platform.

4. The self private key is encrypted by selfKey and selfPass and stored in the web3 contract. It is dynamically calculated and synthesized with the web3 public key as selfDHKey and used as the user's private key to decrypt private data.

5. SelfKey is encrypted by web2DHKey and the user wallet and stored in the web3 contract. It is used to encrypt private data and store it in web2 services and web3 decentralized storage platforms, such as TOTPKey, webAuthn credentials and other private data.

6. The reset function includes TOTP, WebAuthn, SelfPass and user wallet, etc. All reset operations will enable a complete association verification process to strengthen security protection. At the same time, TOTP and WebAuthn reset need one of them to be valid, otherwise you need to go through other than Email Audit and verification outside of calibration

7. For dapp business, all related operations that need to be written into the web3 contract require TOTP and webAuthn dynamic verification. Sensitive operations will trigger email verification.

### web3 mode

1. The initialization process needs to first complete the legality verification of the wasm file, otherwise no data in the contract can be queried and updated.

2. Supports reading and writing data to web3 contracts. The private dynamic authorization process requires on-chain verification, that is, wallet -> TOTP -> webAuthn

3. As a guarantor, the web2 service provides targeted value-added services while endorsing association verification. If the user chooses not to use it or the service fails, the user's ciphertext data will be obtained from the web3 decentralized platform.

4. Since there is no support for the web2 service, dynamic signatures cannot be obtained. Only a single private signature provides guarantee for dynamic authorization. On-chain verification will only support verification of dynamic signatures signed by the self private key.

5. Due to the lack of web2 service support, the Merkel tree association verification certificate cannot be obtained. Users can choose whether to enable sensitive operations on the chain without association verification (not recommended, extremely dangerous!!!)

6. Since there is no support for the web2 service, the email verification function will be temporarily limited, but it will not affect the normal operation of the web3 business.

7. Registration, association verification for sensitive operations, and all recovery reset functions are not supported

### Private deployment

```shell
git clone https://github.com/refitor/selfweb3.git

cd selfweb3

chmod +x ./build.sh

./build.sh
```

### use

```
./selfweb3
```

[1]: /docs/selfweb3-arch-zh.md
[2]: https://refitself.medium.com/a-privatized-web3-security-model-selfweb3-209439c5d8e2